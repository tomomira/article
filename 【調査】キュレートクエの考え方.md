# Agents for Amazon Bedrock: Text-to-SQLにおけるキュレートクエリの考え方

Agents for Amazon BedrockのText-to-SQL機能には、「キュレートクエリ（Curated Queries）」という設定項目があります。これは、動的なSQL生成を補完し、システムの信頼性とガバナンスを向上させるための重要な機能です。

## キュレートクエリとは？

特定の、よく利用される質問パターンに対して、**人間が手動で記述・最適化した「正解」のSQLクエリをあらかじめ登録しておく機能**です。

「自然言語の質問テンプレート」と「実行させたいSQLクエリ」をペアで設定します。

-   **自然言語テンプレートの例**: `「{支店名}」の「{期間}」における売上トップ3を教えて`
-   **対応するSQLクエリの例**:
    ```sql
    SELECT product_name, SUM(sales_amount)
    FROM sales_data
    WHERE branch_name = ? AND sales_date BETWEEN ? AND ?
    GROUP BY product_name
    ORDER BY SUM(sales_amount) DESC
    LIMIT 3;
    ```

ユーザーからの質問がこのテンプレートに合致した場合、エージェントはLLMで動的にSQLを生成するのではなく、登録済みのSQLを優先的に使用します。

## テンプレート型と固定値型

キュレートクエリには、その設定方法によって大きく2つの使い方があります。

### 1. テンプレート型（推奨）

質問文の一部を `{}` で囲んだ**パラメータ**にすることで、柔軟な問い合わせに対応させる使い方です。これがキュレートクエリの本来の強力な機能です。

-   **自然言語テンプレート**:
    `「{取得したい日付}」に発生した異常値データを取得してください。`
-   **対応するSQLクエリ**:
    `select "device_id","datetime","target" as "anomaly_forecast" from public.anomaly where date("datetime") = ? order by "target" DESC;`

この設定により、ユーザーは「2023年5月1日のデータ」「昨日のデータ」など、日付を自由に変えて質問できるようになります。

### 2. 固定値型

質問文とSQLクエリにパラメータを含めず、完全に1対1で対応させる使い方です。

-   **自然言語の質問**:
    `2015年12月10日に発生した異常値データを取得してください。`
-   **対応するSQLクエリ**:
    `select "device_id","datetime","target" as "anomaly_forecast" from public.anomaly where date("datetime") = '2015-12-10' order by "target" DESC;`

この場合、「2015年12月10日」という特定の日付の問い合わせにしか応答できません。テンプレート型に比べて柔軟性はありませんが、パラメータが不要な定点観測や、非常に複雑なクエリをメモとして登録しておくといった限定的な用途で利用されることがあります。

## キュレートクエリを利用する最大のメリット

一見、「自分でSQLを書くなら意味がない」と感じられるかもしれませんが、以下の強力なメリットがあります。

### 1. 「テンプレート化」による利用者の拡大

-   SQLを書けない非技術系のユーザー（営業、マーケターなど）でも、テンプレートの`{}`に入る言葉（パラメータ）を変えるだけで、安全かつ正確にデータを引き出せるようになります。
-   開発者は一度「質問の型」を定義するだけで、多くの定型的な問い合わせに自動で対応できます。

### 2. 精度とパフォーマンスの保証

-   **精度の保証**: LLMによるSQL生成は、テーブル構造の誤解や意図しないデータの取得など、間違いを犯す可能性があります。人間が書いた100%正しいSQLの実行を保証することで、回答の信頼性が飛躍的に向上します。
-   **パフォーマンスの保証**: データ分析の専門家がインデックスなどを考慮してチューニングしたSQLを登録しておくことで、データベースへの負荷を最小限に抑え、高速な応答を実現します。

### 3. ガバナンスとセキュリティの強化

-   **最も重要なメリットの一つです。**
-   LLMに自由にSQLを生成させると、個人情報などの機密データにアクセスしたり、意図せず`UPDATE`や`DELETE`を実行したりするリスクが伴います。
-   キュレートクエリは**「実行を許可するSQLのホワイトリスト」**として機能します。ここに登録されたクエリしか実行されないようにすることで、安全なデータアクセス環境を構築できます。

## まとめ

キュレートクエリは、動的なText-to-SQLの柔軟性を補完する機能です。

-   **動的生成**: 未知の質問に対応できる柔軟性を持つが、精度やセキュリティに課題がある。
-   **キュレートクエリ**: 定型的な質問に対して、**精度・パフォーマンス・セキュリティを100%保証**する。

この2つを組み合わせることで、柔軟性と信頼性を両立した、強力な自然言語データベースクエリシステムを構築できます。
